# Mask Processing Pipeline Documentation (`01_mask_processing_pipeline.py`)

## Overview

This Python script processes brain atlas registration masks generated by BrainGlobe to optimize them for import into Imaris. It simplifies complex brain region hierarchies, removes small disconnected regions, and ensures compatibility with Imaris Import Segmentations/Labels function.

## Purpose

The mask processing pipeline addresses several problems:
- **Hierarchy Simplification**: Combines detailed brain regions into larger parent regions
- **Fragment Cleanup**: Removes disconnected small regions, that make working with Imaris unusable
- **ID Compatibility**: Ensures region IDs fit within the selected image type (16-bit)
- **Brain region name-ID mapping**: Creates a csv with mapping of region IDs to corresponding names

## Dependencies

### Required Python Packages
```python
import tifffile                    # TIFF image I/O
from brainglobe_atlasapi import BrainGlobeAtlas  # Atlas data access
from scipy.ndimage import generate_binary_structure  # Morphological operations
from tkinter import Tk, filedialog  # GUI file selection
import os                         # File system operations
import numpy as np               # Numerical operations (imported in functions)
import pandas as pd              # Data manipulation (imported in functions)
```

### Installation
```bash
conda activate brainglobe_env
pip install tifffile scipy pandas tkinter
```

## Configuration Parameters

### File Names
```python
input_mask_filename = "registered_atlas_original_orientation.tiff"
output_mask_filename = "adjusted_mask.tiff"
whole_brain_mask_filename = "whole_brain_mask.tiff"
output_label_csv = "used_region_ids.csv"
output_fragment_csv = "region_fragments_with_sizes.csv"
```

### Atlas Configuration
```python
atlas_name = "perens_lsfm_mouse_20um"  # BrainGlobe atlas identifier
min_fragment_size = 50                  # Minimum voxels to keep fragments
```

### Region Processing Lists

#### Regions to Flatten (Complete Merge)
```python
regions_to_flatten = [
    "fiber tracts",  # White matter tracts
    "VS",           # Ventricular system
    "CB",           # Cerebellum
    "HB",           # Hindbrain
    "MB",           # Midbrain
    "TH",           # Thalamus
    "HY",           # Hypothalamus
    "STR",          # Striatum
    "PAL",          # Pallidum
    "CTXsp"         # Cortical subplate (includes amygdala)
]
```

**Rationale**: These regions contain numerous small subdivisions that create excessive complexity in Imaris. Flattening reduces a lot of tiny regions to manageable parent regions. Regions can be adjusted as needed.

#### Regions to Flatten at Level 1
```python
regions_to_flatten_on_level_1 = [
    "Isocortex",    # Isocortical areas
    "OLF"           # Olfactory areas
]
```

**Rationale**: Preserves first-level subdivisions (e.g., primary visual cortex, primary motor cortex) while merging finer subdivisions (layers, subareas).

#### Regions to Exclude
```python
regions_to_exclude = [
    "fiber tracts",  # Removed due to thin, fragmented structure
    "root"           # Non-informative parent region
]
```

**Rationale**: 
- **Fiber tracts**: Often fragment into many disconnected pieces during registration
- **Root**: Generic parent region that doesn't provide anatomical information

## Advanced Configuration

### Customizing Region Lists

#### Adding New Regions to Flatten
```python
# Find region names in atlas
print(atlas.structures.keys())

# Add to appropriate list
regions_to_flatten.append("new_region_name")
```

#### Changing Hierarchy Levels
```python
# Keep more detailed subdivisions
regions_to_flatten_on_level_2 = ["Isocortex"]
simplified_mask = flatten_descendants_of_level(
    simplified_mask, atlas, regions_to_flatten_on_level_2, level=2
)
```

### Adjusting Fragment Size Threshold
```python
# More aggressive cleanup (removes more small fragments)
min_fragment_size = 100

# More conservative cleanup (keeps smaller fragments)
min_fragment_size = 20
```

**Considerations**:
- **Larger values**: Cleaner results, may remove legitimate small structures
- **Smaller values**: Preserves detail, may keep artifacts
- **Recommended range**: 20-100 voxels depending on resolution

### Connectivity Options
```python
# More aggressive connection (edge and corner connectivity)
structure = generate_binary_structure(rank=3, connectivity=2)

# More conservative connection (face connectivity only)
structure = generate_binary_structure(rank=3, connectivity=1)
```

## Workflow Steps

### Step 0: Directory Selection
```python
path = askdirectory(title='Select Folder')
if not path:
    print("No folder selected. Exiting.")
    exit(1)
os.chdir(path)
```

**Process**:
- Opens GUI dialog for folder selection
- Sets working directory to selected folder
- Expects to find input mask file in this directory

### Step 1: Data Loading
```python
atlas = BrainGlobeAtlas(atlas_name)
mask = tifffile.imread(input_mask_filename)
```

**Process**:
- Downloads/loads specified atlas from BrainGlobe
- Reads the registered mask TIFF file
- Validates file format and dimensions

### Step 2: Whole Brain Mask Creation
```python
whole_brain_mask = create_whole_brain_mask(mask)
```

**Purpose**: Creates a binary mask of the entire brain region for:
- Quality control and visualization
- Downstream analysis requiring brain boundaries
- Validation of registration quality

### Step 3: Mask Simplification
```python
simplified_mask = flatten_regions(mask, atlas, regions_to_flatten)
simplified_mask = flatten_descendants_of_level(simplified_mask, atlas, regions_to_flatten_on_level_1, level=1)
simplified_mask = exclude_regions(simplified_mask, atlas, regions_to_exclude)
```

**Process**:
1. **Complete Flattening**: Merges all descendants of specified regions into parent
2. **Level-Specific Flattening**: Preserves specified hierarchy levels
3. **Region Exclusion**: Removes specified regions (sets to 0)

### Step 4: Fragment Cleanup
```python
structure = generate_binary_structure(rank=3, connectivity=1)
cleaned_mask, fragment_info = remove_small_fragments(simplified_mask, min_fragment_size, structure, atlas)
```

**Process**:
- **Connectivity**: Uses 6-connectivity (face-connected voxels only)
- **Size Filtering**: Removes fragments smaller than `min_fragment_size`
- **Documentation**: Records all fragments and their fates

**Connectivity Choice**: Face-connectivity (connectivity=1) is used because:
- Edge/corner connections often create artificial connections
- Results in more conservative fragment removal
- Better matches Imaris segmentation behavior

### Step 5: ID Remapping
```python
adjusted_mask, id_remap, new_id_to_old_id = remap_large_values(cleaned_mask)
```

**Purpose**: Ensures compatibility with 16-bit integer formats:
- **Problem**: Some atlas IDs exceed 65,535 (uint16 maximum)
- **Solution**: Maps large IDs to available smaller IDs
- **Preservation**: Maintains bidirectional mapping for reference

### Step 6-9: Output Generation
The pipeline generates multiple output files for different purposes:

#### Adjusted Mask (`adjusted_mask.tiff`)
- **Format**: 16-bit TIFF
- **Content**: Processed mask with simplified regions
- **Use**: Import into Imaris for visualization

#### Whole Brain Mask (`whole_brain_mask.tiff`)
- **Format**: 8-bit TIFF
- **Content**: Binary mask of entire brain
- **Use**: Quality control, boundary visualization

#### Region Labels (`used_region_ids.csv`)
- **Columns**: `region_id`, `region_name`, `region_acronym`
- **Content**: All regions present in final mask
- **Use**: Imaris label import, analysis reference

#### Fragment Details (`region_fragments_with_sizes.csv`)
- **Columns**: `region_id`, `region_name`, `fragment_index`, `fragment_size_voxels`, `removed`
- **Content**: Complete fragment analysis
- **Use**: Quality control, processing validation

## Quality Control

### Validation Steps

1. **Input Validation**
   ```python
   print(f"Original mask shape: {mask.shape}")
   print(f"Original unique regions: {len(np.unique(mask))}")
   ```

2. **Processing Validation**
   ```python
   print(f"Simplified unique regions: {len(np.unique(simplified_mask))}")
   print(f"Final unique regions: {len(np.unique(adjusted_mask))}")
   ```

3. **Output Validation**
   ```python
   # Check ID range compatibility
   max_id = np.max(adjusted_mask)
   print(f"Maximum ID in final mask: {max_id} (should be â‰¤ 65535)")
   ```

### Common Issues and Solutions

#### Missing Regions
**Symptoms**: Expected regions not in output CSV
**Causes**:
- Region excluded during processing
- Region too small after fragment removal
- Region name/ID mismatch with atlas

**Debugging**:
```python
# Check if region exists in atlas
region_name = "target_region"
if region_name in atlas.structures:
    print(f"Region ID: {atlas.structures[region_name]['id']}")
else:
    print("Region not found in atlas")
```

#### Excessive Fragmentation
**Symptoms**: Too many small fragments reported
**Solutions**:
- Increase `min_fragment_size`
- Check registration quality
- Verify atlas compatibility

#### ID Conflicts
**Symptoms**: Duplicate or invalid IDs in output
**Causes**:
- Atlas ID conflicts
- Remapping errors

**Solutions**:
- Check atlas version compatibility
- Verify ID remapping logic
- Update atlas if necessary


## Integration with Pipeline

### Prerequisites
- Completed registration in Napari/BrainGlobe
- `registered_atlas_original_orientation.tiff` in working directory
- Properly configured BrainGlobe environment

### Next Steps
1. **Quality Review**: Examine output masks in ImageJ or Napari
2. **Imaris Import**: Use adjusted mask for surface generation
3. **Label Assignment**: Apply region labels using Imaris XTension

### File Dependencies
- **Input**: `registered_atlas_original_orientation.tiff` (from BrainGlobe registration)
- **Output**: Multiple files for Imaris import and analysis
- **Following step**: Imaris import and label assignment (Step 4 of pipeline)

## Troubleshooting Guide

### Error Messages and Solutions

#### "Atlas not found"
- **Cause**: Incorrect `atlas_name` or missing atlas
- **Solution**: Check available atlases with `BrainGlobeAtlas.list_atlases()`

#### "File not found"
- **Cause**: Incorrect filename or wrong directory
- **Solution**: Verify file exists in selected directory

#### "Memory allocation error"
- **Cause**: Insufficient RAM for large images
- **Solution**: Use smaller images or increase system memory

#### "Invalid region name"
- **Cause**: Region name not in atlas
- **Solution**: Check atlas structure tree for correct names
